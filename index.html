<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="LN8vjhgl2L8amNIRx59azvFPVaqGBSZP03KDS9u4dok" />
    <title>Tính Toán Nhanh Cho Kỹ Sư</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N7YBDJMQXE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N7YBDJMQXE');
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .btn {
            transition: all 0.2s ease;
            transform: scale(1);
        }
        .btn:active {
            transform: scale(0.97);
        }
        .input-field, .select-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        #result-card {
            border-left: 5px solid #10b981;
        }
        #warning-card {
             border-left: 5px solid #f97316;
        }
        #error-card {
            border-left: 5px solid #ef4444;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .input-wrapper {
            /* Wrapper for conditional inputs */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="max-w-xl mx-auto p-4 md:p-6">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Sổ Tay Kỹ Sư</h1>
            <p class="text-gray-600 mt-1">Công cụ tính toán nhanh tại công trường</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Screen 1: Category Selection -->
            <div id="category-screen" class="screen active">
                <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-center">Chọn chuyên ngành của bạn</h2>
                    <div id="category-buttons" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Category buttons will be inserted here by JS -->
                    </div>
                </div>
                <!-- Add to Home Screen Hint -->
                <div class="mt-6">
                    <div class="card p-4 bg-sky-50 border-l-4 border-sky-500 text-sky-800">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-bold">
                                    Ghim ra màn hình chính để truy cập nhanh!
                                </p>
                                <p class="text-xs mt-1">
                                    <strong>Trên iPhone (Safari):</strong> Bấm nút Chia sẻ (biểu tượng mũi tên lên) → 'Thêm vào MH chính'.<br>
                                    <strong>Trên Android (Chrome):</strong> Bấm menu (⋮) → 'Thêm vào Màn hình chính'.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen 2: Calculation Screen -->
            <div id="calculation-screen" class="screen">
                <div class="card p-6">
                    <div class="flex items-center mb-6">
                        <button id="back-btn" class="btn p-2 rounded-full hover:bg-gray-100 mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="calculation-title" class="text-xl font-bold"></h2>
                    </div>

                    <!-- Formula Selection -->
                    <div class="mb-6">
                        <label for="formula-select" class="block text-sm font-medium text-gray-700 mb-1">Chọn công thức:</label>
                        <select id="formula-select" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options will be inserted here by JS -->
                        </select>
                    </div>

                    <!-- Formula Display -->
                    <div id="formula-text-container" class="text-center bg-blue-50 text-blue-800 p-3 rounded-lg mb-6" style="display: none;">
                        <p class="font-mono text-sm md:text-base" id="formula-text"></p>
                    </div>
                    
                    <!-- Input Fields -->
                    <div id="input-fields" class="space-y-4 mb-6">
                        <!-- Input fields will be inserted here by JS -->
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <button id="calculate-btn" class="btn col-span-2 sm:col-span-1 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Tính Toán
                        </button>
                         <button id="clear-btn" class="btn w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">
                            Xoá
                        </button>
                        <button id="home-btn" class="btn w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">
                            Trang chủ
                        </button>
                    </div>

                    <!-- Result Display -->
                    <div id="result-container" class="mt-6">
                        <!-- Result or error will be shown here -->
                    </div>

                    <!-- Support Section -->
                    <div id="support-section" class="mt-8" style="display: none;">
                        <div class="card p-6 text-center bg-gray-50">
                            <h3 class="text-lg font-semibold text-gray-800">Thấy ứng dụng hữu ích?</h3>
                            <p class="text-sm text-gray-600 mt-2 max-w-md mx-auto">
                                Mọi sự đóng góp, dù nhỏ nhất, đều là nguồn động viên to lớn để tác giả duy trì và phát triển thêm nhiều tính năng mới.
                            </p>
                            <div class="mt-4 flex flex-col md:flex-row items-center justify-center gap-6">
                                <div class="flex-shrink-0">
                                    <img src="ma-qr.png" alt="QR Code Ung Ho" class="w-36 h-36 rounded-lg object-cover" onerror="this.onerror=null;this.src='https://placehold.co/144x144/e2e8f0/334155?text=QR+Code';">
                                </div>
                                <div class="text-left text-sm space-y-1">
                                    <p><strong>Ngân hàng:</strong> ACB</p>
                                    <p><strong>Số tài khoản:</strong> 33505737</p>
                                    <p><strong>Chủ tài khoản:</strong> HUYNH THI KIM DINH</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-4 italic">
                                Đây là hình thức ủng hộ hoàn toàn tự nguyện, không phải là một khoản phí bắt buộc để sử dụng ứng dụng.
                            </p>
                            <div class="border-t border-gray-200 mt-4 pt-4 text-xs text-gray-500">
                                <p>Góp ý hoặc báo lỗi, vui lòng liên hệ:</p>
                                <p class="font-semibold">hocthuoclong2k@gmail.com</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const cosphiOptions = [
                { value: 0.9, text: 'Tổng thể dự án (khuyến nghị) - 0.9' },
                { value: 0.85, text: 'Động cơ (thông thường) - 0.85' },
                { value: 0.92, text: 'Đèn huỳnh quang/LED - 0.92' },
                { value: 1.0, text: 'Tải thuần trở (bếp, nóng lạnh) - 1.0' },
                { value: 1.0, text: 'Dòng điện một chiều (DC) - 1.0' },
                { value: 0.7, text: 'Thiết bị điện tử cũ - 0.7' }
            ];

            const materialOptions = [
                { value: 0.0175, text: 'Dây đồng (ρ ≈ 0.0175)' },
                { value: 0.0282, text: 'Dây nhôm (ρ ≈ 0.0282)' }
            ];

            const environmentOptions = [
                { value: 'indoor', text: 'Đi trong nhà, trong ống luồn' },
                { value: 'underground', text: 'Đi ngầm trực tiếp trong đất' },
                { value: 'aerial', text: 'Đi trên không (treo trên cột)' }
            ];
            
            const ventilationRoomTypes = [
                { value: 12, text: 'Nhà vệ sinh (10-15 lần/h)' },
                { value: 15, text: 'Nhà bếp (15-20 lần/h)' },
                { value: 8, text: 'Văn phòng (6-10 lần/h)' },
                { value: 10, text: 'Tầng hầm / Bãi xe (8-12 lần/h)' },
                { value: 6, text: 'Phòng ngủ (4-8 lần/h)' },
                { value: 10, text: 'Phòng họp (8-12 lần/h)' }
            ];

            const ductVelocityOptions = [
                { value: 2.5, text: 'Phòng ngủ, khu vực yên tĩnh (2-3 m/s)' },
                { value: 4, text: 'Văn phòng, không gian chung (3-5 m/s)' },
                { value: 6, text: 'Hành lang, khu vực công cộng (5-7 m/s)' },
                { value: 8, text: 'Ống gió chính, nhà xưởng (7-9 m/s)' }
            ];
            
            const buildingTypes = [
                { value: 200, text: 'Nhà ở gia đình' },
                { value: 250, text: 'Căn hộ chung cư' },
                { value: 100, text: 'Văn phòng' },
                { value: 300, text: 'Khách sạn / Nhà hàng' }
            ];

            const pressureOptions = [
                { value: 10, text: 'Nhà ở, căn hộ (10m)' },
                { value: 15, text: 'Văn phòng, tòa nhà nhỏ (15m)' },
                { value: 20, text: 'Khách sạn, nhà hàng (20m)' }
            ];

            const storageDurationOptions = [
                { value: 0.5, text: 'Nửa ngày (dự phòng tối thiểu)' },
                { value: 1, text: '1 ngày (tiêu chuẩn)' },
                { value: 2, text: '2 ngày (khu vực hay mất nước)' },
                { value: 7, text: '1 tuần (yêu cầu đặc biệt)' }
            ];

            const illuminanceStandards = [
                { value: 150, text: 'Phòng ngủ, hành lang' },
                { value: 300, text: 'Phòng khách, phòng ăn' },
                { value: 500, text: 'Văn phòng, nhà bếp, lớp học' },
                { value: 750, text: 'Xưởng cơ khí chính xác' },
                { value: 20, text: 'Đường phố, khu vực ngoài trời' }
            ];

            const lampTypes = [
                { value: 1000, text: 'Tuýp LED T8 0.6m (≈1000 lm)' },
                { value: 2000, text: 'Tuýp LED T8 1.2m (≈2000 lm)' },
                { value: 4000, text: 'Panel LED 600x600 (≈4000 lm)' },
                { value: 900, text: 'Downlight LED âm trần (≈900 lm)' },
                { value: 20000, text: 'Highbay LED nhà xưởng (≈20000 lm)' },
                { value: 13000, text: 'Đèn đường LED (≈13000 lm)' },
                { value: 'custom', text: 'Loại khác (nhập thủ công)' }
            ];

            const reflectivityOptions = [
                { value: 0.7, text: 'Tường/Trần sáng màu' },
                { value: 0.6, text: 'Tường/Trần màu trung tính' },
                { value: 0.5, text: 'Tường/Trần tối màu' }
            ];

            const formulas = {
                'dien': {
                    name: 'Kỹ Thuật Điện',
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`,
                    calculations: {
                        'chonCB1pha': {
                            name: 'Chọn CB cho tải 1 pha / DC',
                            inputs: [
                                { label: 'Công suất tải (P) - Đơn vị Watt (W)', id: 'p', unit: 'W' },
                                { label: 'Điện áp (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 220 },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions, default: 0.85 }
                            ],
                            calculate: (vals) => {
                                const i_load = vals.p / (vals.u * vals.cosphi);
                                const i_cb = i_load * 1.25; // Safety factor
                                const poles = (vals.cosphi === 1.0 && vals.u < 1000) ? '2P (cho DC)' : '1P/2P';

                                if (vals.u > 1000) {
                                    return {
                                        type: 'warning',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                        unit: `Điện áp: ${vals.u}V`,
                                        note: `<strong>Hệ thống trung/cao thế!</strong> Yêu cầu sử dụng VCB (Máy cắt chân không) và cần kỹ sư chuyên môn thiết kế.`
                                    };
                                }

                                const standardMCBs = [6, 10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125];
                                const standardMCCBs = [160, 200, 250, 400, 630, 800, 1000, 1250, 1600, 2000, 2500];
                                
                                let suggestedCB = standardMCBs.find(cb => cb >= i_cb);
                                if (suggestedCB) {
                                    return { 
                                        type: 'result',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`, 
                                        unit: `Gợi ý chọn: MCB ${suggestedCB} A`,
                                        note: `Số cực đề xuất: ${poles}. Lưu ý chọn đúng loại CB AC/DC và dòng cắt (kA) phù hợp.`
                                    };
                                }

                                suggestedCB = standardMCCBs.find(cb => cb >= i_cb);
                                if (suggestedCB) {
                                    return {
                                        type: 'result',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                        unit: `Gợi ý chọn: MCCB ${suggestedCB} A`,
                                        note: `Số cực đề xuất: ${poles}. Lưu ý chọn đúng loại CB AC/DC và dòng cắt (kA) phù hợp.`
                                    };
                                }
                                
                                return {
                                    type: 'warning',
                                    value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                    unit: `Yêu cầu CB > ${standardMCCBs[standardMCCBs.length - 1]} A`,
                                    note: `<strong>Dòng tải quá lớn!</strong> Cần tham vấn kỹ sư thiết kế.`
                                };
                            },
                            formulaText: 'I = P / (U × cosφ)'
                        },
                        'chonCB3pha': {
                            name: 'Chọn CB cho tải 3 pha',
                            inputs: [
                                { label: 'Công suất tải (P) - Đơn vị Watt (W)', id: 'p', unit: 'W' },
                                { label: 'Điện áp dây (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 380 },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions.filter(o => o.text.indexOf('DC') === -1), default: 0.9 }
                            ],
                            calculate: (vals) => {
                                const i_load = vals.p / (vals.u * vals.cosphi * Math.sqrt(3));
                                const i_cb = i_load * 1.25; // Safety factor
                                
                                if (vals.u > 1000) {
                                    const standardVCBs = [4000, 5000, 6300];
                                    const suggestedVCB = standardVCBs.find(cb => cb >= i_cb);
                                    if (suggestedVCB) {
                                        return {
                                            type: 'result',
                                            value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                            unit: `Gợi ý chọn: VCB ${suggestedVCB} A (3P/4P)`,
                                            note: `Áp dụng cho hệ thống trung/cao thế.`
                                        };
                                    } else if (i_cb > 6300) {
                                         return {
                                            type: 'warning',
                                            value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                            unit: `Yêu cầu CB > 6300 A`,
                                            note: `<strong>Dòng tải cực lớn!</strong> Cần giải pháp chuyên dụng và tham vấn kỹ sư thiết kế.`
                                        };
                                    }
                                    return {
                                        type: 'warning',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                        unit: `Điện áp: ${vals.u}V`,
                                        note: `<strong>Hệ thống trung/cao thế!</strong> Yêu cầu sử dụng thiết bị đóng cắt chuyên dụng (LBS, VCB...) và cần kỹ sư thiết kế.`
                                    };
                                }

                                const standardLVCBs = [6, 10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160, 200, 250, 320, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3200, 4000, 5000, 6300];
                                const suggestedCB = standardLVCBs.find(cb => cb >= i_cb);

                                if (suggestedCB) {
                                    let cbType = '';
                                    if (suggestedCB <= 125) cbType = 'MCB';
                                    else if (suggestedCB <= 2500) cbType = 'MCCB';
                                    else cbType = 'ACB';

                                    return { 
                                        type: 'result',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`, 
                                        unit: `Gợi ý chọn: ${cbType} ${suggestedCB} A (3P/4P)`,
                                        note: `Lưu ý chọn dòng cắt ngắn mạch (kA) phù hợp với mạng điện.`
                                    };
                                } else {
                                    return {
                                        type: 'warning',
                                        value: `Dòng tải sử dụng: ${i_load.toFixed(2)} A`,
                                        unit: `Yêu cầu CB > ${standardLVCBs[standardLVCBs.length - 1]} A`,
                                        note: `<strong>Dòng tải quá lớn!</strong> Cần tham vấn kỹ sư thiết kế.`
                                    };
                                }
                            },
                            formulaText: 'I = P / (√3 × U × cosφ)'
                        },
                        'chonDayDien1pha': {
                            name: 'Chọn dây dẫn (1 pha / DC)',
                            inputs: [
                                { label: 'Tính toán theo', id: 'inputType', type: 'select', options: [{value: 'power', text: 'Công suất (W)'}, {value: 'current', text: 'Dòng điện (A)'}], default: 'power' },
                                { label: 'Công suất tải (P) - Đơn vị Watt (W)', id: 'p', unit: 'W', 'showIf': {'id': 'inputType', 'value': 'power'} },
                                { label: 'Dòng điện tải (I) - Đơn vị Ampe (A)', id: 'i', unit: 'A', 'showIf': {'id': 'inputType', 'value': 'current'} },
                                { label: 'Điện áp (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 220 },
                                { label: 'Loại vật liệu dây', id: 'material', type: 'select', options: materialOptions, default: 0.0175 },
                                { label: 'Môi trường lắp đặt', id: 'environment', type: 'select', options: environmentOptions, default: 'indoor' },
                                { label: 'Chiều dài dây (L) - Đơn vị mét (m)', id: 'l', unit: 'm' },
                                { label: 'Độ sụt áp cho phép (%)', id: 'drop', unit: '%', default: 3 },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions, default: 0.85 }
                            ],
                            calculate: (vals) => {
                                let i_load;
                                if (vals.inputType === 'power') {
                                    if (isNaN(vals.p)) throw new Error('Vui lòng nhập Công suất (P).');
                                    i_load = vals.p / (vals.u * vals.cosphi);
                                } else {
                                    if (isNaN(vals.i)) throw new Error('Vui lòng nhập Dòng điện (I).');
                                    i_load = vals.i;
                                }

                                const delta_u_max = vals.u * (vals.drop / 100);
                                const rho = parseFloat(vals.material);
                                const s_required = (2 * vals.l * i_load * rho) / delta_u_max;
                                const standardWires = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400];
                                const suggestedWire = standardWires.find(wire => wire >= s_required);
                                const materialName = rho === 0.0175 ? 'đồng' : 'nhôm';
                                
                                let cableSuggestion = '';
                                switch (vals.environment) {
                                    case 'indoor': cableSuggestion = 'Gợi ý loại cáp: CV, CVV.'; break;
                                    case 'underground': cableSuggestion = 'Gợi ý loại cáp: CXV, DSTA (có giáp).'; break;
                                    case 'aerial': cableSuggestion = 'Gợi ý loại cáp: CXV, ASV (cáp vặn xoắn).'; break;
                                }

                                if(suggestedWire) {
                                    return {
                                        type: 'result',
                                        value: `Tiết diện yêu cầu: ${s_required.toFixed(2)} mm²`,
                                        unit: `Gợi ý chọn dây ${materialName}: ${suggestedWire} mm²`,
                                        note: cableSuggestion
                                    };
                                } else {
                                     return {
                                        type: 'warning',
                                        value: `Tiết diện yêu cầu: ${s_required.toFixed(2)} mm²`,
                                        unit: `Yêu cầu dây > ${standardWires[standardWires.length - 1]} mm²`,
                                        note: `<strong>Tiết diện quá lớn!</strong> Cần xem xét lại phương án đi dây hoặc chia tải.`
                                    };
                                }
                            },
                            formulaText: 'S = (2 × L × I × ρ) / ΔU'
                        },
                        'chonDayDien3pha': {
                            name: 'Chọn dây dẫn (3 pha)',
                            inputs: [
                                { label: 'Tính toán theo', id: 'inputType', type: 'select', options: [{value: 'power', text: 'Công suất (W)'}, {value: 'current', text: 'Dòng điện (A)'}], default: 'power' },
                                { label: 'Công suất tải (P) - Đơn vị Watt (W)', id: 'p', unit: 'W', 'showIf': {'id': 'inputType', 'value': 'power'} },
                                { label: 'Dòng điện tải (I) - Đơn vị Ampe (A)', id: 'i', unit: 'A', 'showIf': {'id': 'inputType', 'value': 'current'} },
                                { label: 'Điện áp dây (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 380 },
                                { label: 'Loại vật liệu dây', id: 'material', type: 'select', options: materialOptions, default: 0.0175 },
                                { label: 'Môi trường lắp đặt', id: 'environment', type: 'select', options: environmentOptions, default: 'indoor' },
                                { label: 'Chiều dài dây (L) - Đơn vị mét (m)', id: 'l', unit: 'm' },
                                { label: 'Độ sụt áp cho phép (%)', id: 'drop', unit: '%', default: 3 },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions.filter(o => o.text.indexOf('DC') === -1), default: 0.9 }
                            ],
                            calculate: (vals) => {
                                let i_load;
                                if (vals.inputType === 'power') {
                                    if (isNaN(vals.p)) throw new Error('Vui lòng nhập Công suất (P).');
                                    i_load = vals.p / (Math.sqrt(3) * vals.u * vals.cosphi);
                                } else {
                                    if (isNaN(vals.i)) throw new Error('Vui lòng nhập Dòng điện (I).');
                                    i_load = vals.i;
                                }

                                const delta_u_line_max = vals.u * (vals.drop / 100);
                                const rho = parseFloat(vals.material);
                                const s_required = (Math.sqrt(3) * vals.l * i_load * rho) / delta_u_line_max;
                                const standardWires = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400];
                                const suggestedWire = standardWires.find(wire => wire >= s_required);
                                const materialName = rho === 0.0175 ? 'đồng' : 'nhôm';
                                
                                let cableSuggestion = '';
                                switch (vals.environment) {
                                    case 'indoor': cableSuggestion = 'Gợi ý loại cáp: CV, CVV.'; break;
                                    case 'underground': cableSuggestion = 'Gợi ý loại cáp: CXV, DSTA (có giáp).'; break;
                                    case 'aerial': cableSuggestion = 'Gợi ý loại cáp: CXV, ASV (cáp vặn xoắn).'; break;
                                }

                                if(suggestedWire) {
                                    return {
                                        type: 'result',
                                        value: `Tiết diện yêu cầu: ${s_required.toFixed(2)} mm²`,
                                        unit: `Gợi ý chọn dây ${materialName}: ${suggestedWire} mm²`,
                                        note: cableSuggestion
                                    };
                                } else {
                                     return {
                                        type: 'warning',
                                        value: `Tiết diện yêu cầu: ${s_required.toFixed(2)} mm²`,
                                        unit: `Yêu cầu dây > ${standardWires[standardWires.length - 1]} mm²`,
                                        note: `<strong>Tiết diện quá lớn!</strong> Cần xem xét lại phương án đi dây hoặc chia tải.`
                                    };
                                }
                            },
                            formulaText: 'S = (√3 × L × I × ρ) / ΔU_line'
                        },
                        'tinhCongSuat1Pha': {
                            name: 'Tính công suất 1 pha (P)',
                            inputs: [
                                { label: 'Điện áp (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 220 },
                                { label: 'Dòng điện (I) - Đơn vị Ampe (A)', id: 'i', unit: 'A' },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions, default: 0.85 }
                            ],
                            calculate: (vals) => {
                                const p = vals.u * vals.i * parseFloat(vals.cosphi);
                                return { type: 'result', value: `Công suất: ${(p / 1000).toFixed(3)} kW`, unit: `(${p.toFixed(2)} W)` };
                            },
                            formulaText: 'P = U × I × cos(φ)'
                        },
                        'tinhCongSuat3Pha': {
                            name: 'Tính công suất 3 pha (P)',
                            inputs: [
                                { label: 'Điện áp dây (U) - Đơn vị Volt (V)', id: 'u', unit: 'V', default: 380 },
                                { label: 'Dòng điện (I) - Đơn vị Ampe (A)', id: 'i', unit: 'A' },
                                { label: 'Loại tải / Hệ số công suất (cos φ)', id: 'cosphi', type: 'select', options: cosphiOptions.filter(o => o.text.indexOf('DC') === -1), default: 0.9 }
                            ],
                            calculate: (vals) => {
                                const p = Math.sqrt(3) * vals.u * vals.i * parseFloat(vals.cosphi);
                                return { type: 'result', value: `Công suất: ${(p / 1000).toFixed(3)} kW`, unit: `(${p.toFixed(2)} W)` };
                            },
                            formulaText: 'P = √3 × U × I × cos(φ)'
                        }
                    }
                },
                'nhietlanh': {
                    name: 'Nhiệt - Điện Lạnh',
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 7.652a.5.5 0 01.734-.65l.02.022c.19.19.44.293.707.293s.517-.103.707-.293l.02-.022a.5.5 0 01.734.65l-.02.022a1.75 1.75 0 01-2.474 0l-.022-.022zm5.416 0a.5.5 0 01.734-.65l.02.022a1.75 1.75 0 012.474 2.474l-.02.022a.5.5 0 11-.734-.65l.02-.022c.19-.19.293-.44.293-.707s-.103-.517-.293-.707l-.02-.022a.5.5 0 010-.734zM10 14a4 4 0 003.536-2.002.5.5 0 11-.866-.5A3 3 0 0110 13a3 3 0 01-2.67-1.502.5.5 0 11-.866.5A4 4 0 0010 14z" clip-rule="evenodd" /></svg>`,
                    calculations: {
                        'chonMayLanh': {
                            name: 'Tính toán chọn máy lạnh',
                            inputs: [
                                { label: 'Chiều dài phòng (m)', id: 'length', unit: 'm' },
                                { label: 'Chiều rộng phòng (m)', id: 'width', unit: 'm' },
                                { label: 'Chiều cao phòng (m)', id: 'height', unit: 'm', default: 3 },
                                { label: 'Loại phòng', id: 'roomType', type: 'select', options: [{value: 'bedroom', text: 'Phòng ngủ'}, {value: 'livingroom', text: 'Phòng khách/Văn phòng'}], default: 'bedroom' },
                                { label: 'Hướng tường/cửa sổ chính', id: 'direction', type: 'select', options: [{value: 'hot', text: 'Hướng nắng gắt (Tây)'}, {value: 'cool', text: 'Hướng ít nắng'}, {value: 'shaded', text: 'Có che nắng tốt'}], default: 'cool' },
                                { label: 'Số người thường xuyên', id: 'people', unit: 'người', default: 2 },
                                { label: 'Số thiết bị tỏa nhiệt (máy tính, TV)', id: 'equipment', unit: 'cái', default: 1 },
                                { label: 'Phòng có thông với khu vực khác (bếp, cầu thang)?', id: 'isOpen', type: 'select', options: [{value: 'no', text: 'Không'}, {value: 'yes', text: 'Có'}], default: 'no' }
                            ],
                            calculate: (vals) => {
                                const area = vals.length * vals.width;
                                let baseBtu = area * 600; // Base calculation

                                // Adjustments
                                if (vals.direction === 'hot') baseBtu *= 1.2;
                                if (vals.direction === 'shaded') baseBtu *= 0.8;
                                if (vals.roomType === 'livingroom') baseBtu *= 1.1;
                                if (vals.isOpen === 'yes') baseBtu *= 1.3;

                                const peopleBtu = (vals.people > 2 ? vals.people - 2 : 0) * 600;
                                const equipmentBtu = vals.equipment * 1200;

                                const totalBtu = baseBtu + peopleBtu + equipmentBtu;
                                const standardBtus = [9000, 12000, 18000, 24000, 36000, 48000, 60000];
                                const suggestedBtu = standardBtus.find(b => b >= totalBtu) || Math.ceil(totalBtu / 1000) * 1000;
                                const hp = suggestedBtu / 9000;

                                let acTypeSuggestion = '';
                                if (suggestedBtu <= 18000) acTypeSuggestion = 'Gợi ý: Máy lạnh treo tường.';
                                else if (suggestedBtu <= 48000) acTypeSuggestion = 'Gợi ý: Cassette âm trần, Áp trần.';
                                else acTypeSuggestion = 'Gợi ý: Cassette âm trần, Nối ống gió, Tủ đứng.';

                                return {
                                    type: 'result',
                                    value: `Công suất yêu cầu: ${suggestedBtu.toLocaleString()} BTU/h`,
                                    unit: `Tương đương: ${hp.toFixed(1)} HP (ngựa)`,
                                    note: acTypeSuggestion
                                };
                            },
                            formulaText: 'BTU ≈ (Diện tích × 600) + Phụ tải'
                        },
                        'chonQuatThongGio': {
                            name: 'Tính toán quạt thông gió',
                             inputs: [
                                { label: 'Chiều dài phòng (m)', id: 'length', unit: 'm' },
                                { label: 'Chiều rộng phòng (m)', id: 'width', unit: 'm' },
                                { label: 'Chiều cao phòng (m)', id: 'height', unit: 'm', default: 3 },
                                { label: 'Chức năng phòng (bội số trao đổi không khí)', id: 'roomFunction', type: 'select', options: ventilationRoomTypes, default: 12 },
                            ],
                            calculate: (vals) => {
                                const volume = vals.length * vals.width * vals.height;
                                const ach = parseFloat(vals.roomFunction); // Air Changes per Hour
                                const airflowM3H = volume * ach;
                                const airflowCFM = airflowM3H / 1.7; // Approximate conversion

                                let fanTypeSuggestion = 'Gợi ý: Quạt hút gắn tường/trần.';
                                if (airflowM3H > 1000) {
                                    fanTypeSuggestion = 'Gợi ý: Quạt hút/cấp nối ống gió.';
                                }
                                
                                return {
                                    type: 'result',
                                    value: `Lưu lượng gió yêu cầu: ${Math.round(airflowM3H).toLocaleString()} m³/h`,
                                    unit: `Tương đương: ${Math.round(airflowCFM).toLocaleString()} CFM`,
                                    note: fanTypeSuggestion
                                };
                            },
                            formulaText: 'Lưu lượng gió (m³/h) = Thể tích (m³) × Bội số trao đổi (lần/h)'
                        },
                        'chonTietDienOngGio': {
                            name: 'Tính tiết diện ống gió',
                            inputs: [
                                { label: 'Lưu lượng gió (m³/h)', id: 'airflow', unit: 'm³/h' },
                                { label: 'Vận tốc gió trong ống', id: 'velocity', type: 'select', options: ductVelocityOptions, default: 4 }
                            ],
                            calculate: (vals) => {
                                const area_m2 = vals.airflow / (vals.velocity * 3600);
                                const round_diameter_mm = Math.sqrt((4 * area_m2) / Math.PI) * 1000;
                                const square_side_mm = Math.sqrt(area_m2) * 1000;

                                return {
                                    type: 'result',
                                    value: `Tiết diện yêu cầu: ${area_m2.toFixed(4)} m²`,
                                    unit: `Ống tròn tương đương: Ø${Math.round(round_diameter_mm)} mm`,
                                    note: `Gợi ý ống chữ nhật (vuông): ${Math.round(square_side_mm)} x ${Math.round(square_side_mm)} mm. Điều chỉnh tỉ lệ cạnh cho phù hợp.`
                                };
                            },
                            formulaText: 'Tiết diện (m²) = Lưu lượng (m³/h) / (Vận tốc (m/s) × 3600)'
                        }
                    }
                },
                'nuoc': {
                    name: 'Cấp Thoát Nước',
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a3.5 3.5 0 01-3.5-3.5V5a.5.5 0 011 0v7.5a2.5 2.5 0 002.5 2.5h9a.5.5 0 010 1h-9z" /><path d="M17.293 3.293a1 1 0 011.414 0l.707.707a1 1 0 010 1.414l-2 2a1 1 0 01-1.414 0l-1-1a1 1 0 010-1.414l2-2a1 1 0 010-1.414zM14.5 9.5a1 1 0 00-1 1v.01a1 1 0 001 1h.01a1 1 0 001-1V10.5a1 1 0 00-1-1h-.01z" /></svg>`,
                    calculations: {
                        'chonBomTangAp': {
                            name: 'Tính bơm tăng áp đường ống',
                            inputs: [
                                { label: 'Công năng tòa nhà (Tiêu chuẩn dùng nước)', id: 'buildingType', type: 'select', options: buildingTypes, default: 200 },
                                { label: 'Số người sử dụng', id: 'numPeople', unit: 'người' },
                                { label: 'Chiều cao tới điểm dùng nước cao nhất (m)', id: 'highestPoint', unit: 'm' },
                                { label: 'Áp lực yêu cầu tại vòi (tiêu chuẩn)', id: 'pressureAtTap', type: 'select', options: pressureOptions, default: 10 }
                            ],
                            calculate: (vals) => {
                                const consumptionRate = parseFloat(vals.buildingType);
                                const dailyDemand_L = vals.numPeople * consumptionRate;
                                const peakFlow_m3h = (dailyDemand_L * 2.5) / (1000 * 24);

                                const staticHead_m = vals.highestPoint;
                                const frictionLoss_m = staticHead_m * 0.2;
                                const requiredPressure_m = parseFloat(vals.pressureAtTap);
                                const totalHead_m = staticHead_m + frictionLoss_m + requiredPressure_m;
                                
                                const pumpEfficiency = 0.6; // Assume 60% efficiency
                                const power_kW = (peakFlow_m3h * totalHead_m) / (367 * pumpEfficiency);
                                const power_HP = power_kW / 0.746;

                                const standardHP = [0.5, 1, 1.5, 2, 3, 5, 7.5, 10];
                                const suggestedHP = standardHP.find(hp => hp >= power_HP) || Math.ceil(power_HP);
                                const suggestedKW = suggestedHP * 0.746;

                                const pumpSuggestion = `Gợi ý bơm tăng áp ${suggestedHP} HP (${suggestedKW.toFixed(1)} kW) với cột áp ~${totalHead_m.toFixed(1)}m.`;

                                return {
                                    type: 'result',
                                    value: `Lưu lượng yêu cầu: ${peakFlow_m3h.toFixed(2)} m³/h`,
                                    unit: `Cột áp tổng yêu cầu: ${totalHead_m.toFixed(1)} m`,
                                    note: `${pumpSuggestion} Tham khảo biểu đồ hiệu suất của nhà sản xuất để có lựa chọn chính xác nhất.`
                                };
                            },
                            formulaText: 'H_tổng = H_tĩnh + H_tổn thất + H_tự do'
                        },
                        'chonBomDayBon': {
                            name: 'Tính bơm cấp nước vào bồn',
                            inputs: [
                                { label: 'Dung tích bồn chứa (m³)', id: 'tankVolume', unit: 'm³' },
                                { label: 'Thời gian bơm đầy mong muốn (phút)', id: 'fillTime', unit: 'phút', default: 120 },
                                { label: 'Chiều cao từ bơm đến miệng bồn (m) - (nhập số âm nếu bồn âm)', id: 'tankHeight', unit: 'm' }
                            ],
                            calculate: (vals) => {
                                if (vals.fillTime <= 0) throw new Error('Thời gian bơm đầy phải lớn hơn 0.');
                                const flowRate_m3h = vals.tankVolume / (vals.fillTime / 60);
                                const staticHead_m = vals.tankHeight;
                                const frictionLoss_m = Math.abs(staticHead_m) * 0.15 + 5; 
                                const totalHead_m = staticHead_m + frictionLoss_m;

                                const pumpEfficiency = 0.6;
                                const power_kW = (flowRate_m3h * totalHead_m) / (367 * pumpEfficiency);
                                const power_HP = power_kW / 0.746;

                                const standardHP = [0.5, 1, 1.5, 2, 3, 5];
                                const suggestedHP = standardHP.find(hp => hp >= power_HP) || Math.ceil(power_HP);
                                const suggestedKW = suggestedHP * 0.746;

                                const pumpSuggestion = `Gợi ý bơm đẩy cao/ly tâm ${suggestedHP} HP (${suggestedKW.toFixed(1)} kW) với cột áp ~${totalHead_m.toFixed(1)}m.`;

                                return {
                                    type: 'result',
                                    value: `Lưu lượng yêu cầu: ${flowRate_m3h.toFixed(2)} m³/h`,
                                    unit: `Cột áp yêu cầu: ${totalHead_m.toFixed(1)} m`,
                                    note: `${pumpSuggestion} Tham khảo biểu đồ hiệu suất của nhà sản xuất.`
                                };
                            },
                            formulaText: 'Q = V_bồn / t; H_tổng = H_tĩnh + H_tổn thất'
                        },
                        'chonBonChuaNuoc': {
                            name: 'Tính toán chọn bồn chứa nước',
                            inputs: [
                                { label: 'Công năng tòa nhà (Tiêu chuẩn dùng nước)', id: 'buildingType', type: 'select', options: buildingTypes, default: 200 },
                                { label: 'Số người sử dụng', id: 'numPeople', unit: 'người' },
                                { label: 'Thời gian trữ nước mong muốn', id: 'storageDuration', type: 'select', options: storageDurationOptions, default: 1 }
                            ],
                            calculate: (vals) => {
                                const consumptionRate = parseFloat(vals.buildingType);
                                const dailyDemand_L = vals.numPeople * consumptionRate;
                                const requiredVolume_L = dailyDemand_L * parseFloat(vals.storageDuration);

                                const standardTankSizes = [500, 700, 1000, 1500, 2000, 3000, 4000, 5000, 10000];
                                const suggestedTank = standardTankSizes.find(size => size >= requiredVolume_L) || Math.ceil(requiredVolume_L / 1000) * 1000;

                                return {
                                    type: 'result',
                                    value: `Dung tích yêu cầu: ${requiredVolume_L.toFixed(0)} Lít`,
                                    unit: `(${ (requiredVolume_L / 1000).toFixed(2) } m³)`,
                                    note: `Gợi ý: Chọn bồn chứa nước ${suggestedTank}L. Nên chọn bồn nhựa/inox tùy điều kiện lắp đặt.`
                                };
                            },
                            formulaText: 'V_bồn = (Số người × TCDN) × Thời gian trữ'
                        },
                        'chonOngCapThoat': {
                            name: 'Tính toán chọn ống cấp & thoát nước',
                            inputs: [
                                { label: 'Công năng tòa nhà', id: 'buildingType', type: 'select', options: buildingTypes, default: 200 },
                                { label: 'Số người sử dụng', id: 'numPeople', unit: 'người' },
                                { label: 'Chiều cao tới điểm dùng nước cao nhất (m)', id: 'highestPoint', unit: 'm' }
                            ],
                            calculate: (vals) => {
                                const consumptionRate = parseFloat(vals.buildingType);
                                const dailyDemand_L = vals.numPeople * consumptionRate;
                                const peakFlow_m3h = (dailyDemand_L * 2.5) / (1000 * 24);
                                const peakFlow_m3s = peakFlow_m3h / 3600;

                                const getDiameter = (flow_m3s, velocity_ms) => {
                                    return Math.sqrt((4 * flow_m3s) / (Math.PI * velocity_ms)) * 1000;
                                };
                                
                                const roundToStandardPipeSize = (diameter_mm, standardSizes) => {
                                    return standardSizes.find(size => size >= diameter_mm) || standardSizes[standardSizes.length - 1];
                                };
                                
                                const pipeSizes = [20, 25, 32, 40, 50, 63, 75, 90, 110];
                                const drainSizes = [60, 90, 114, 140, 160];

                                // Calculations
                                const mainPipe_d = getDiameter(peakFlow_m3s, 1.5);
                                const branch1_d = getDiameter(peakFlow_m3s * 0.4, 1.2);
                                const branch2_d = getDiameter((0.7 / 3600), 1.0); // 0.7 m3/h for a fixture group

                                const mainPipe_size = roundToStandardPipeSize(mainPipe_d, pipeSizes);
                                const branch1_size = roundToStandardPipeSize(branch1_d, pipeSizes);
                                const branch2_size = roundToStandardPipeSize(branch2_d, pipeSizes);
                                
                                let mainDrain_size;
                                if (mainPipe_size <= 25) mainDrain_size = 60;
                                else if (mainPipe_size <= 40) mainDrain_size = 90;
                                else mainDrain_size = 114;

                                const pressureClass = vals.highestPoint <= 20 ? 'PN10' : 'PN16';

                                const resultText = `
                                    <div class="space-y-3">
                                        <p><strong>Ống cấp chính:</strong> Ø${mainPipe_size} mm (PPR/HDPE, ${pressureClass})</p>
                                        <p><strong>Ống nhánh cấp 1:</strong> Ø${branch1_size} mm (PPR/HDPE)</p>
                                        <p><strong>Ống nhánh cấp 2:</strong> Ø${branch2_size} mm (PPR)</p>
                                        <p><strong>Ống thoát chính:</strong> Ø${mainDrain_size} mm (uPVC)</p>
                                    </div>
                                `;

                                return {
                                    type: 'result',
                                    value: `Kết quả gợi ý`,
                                    unit: `(Dựa trên lưu lượng đỉnh ${peakFlow_m3h.toFixed(2)} m³/h)`,
                                    note: resultText
                                };
                            },
                            formulaText: 'D = √((4 × Q) / (π × v))'
                        }
                    }
                },
                'chieu_sang': {
                    name: 'Chiếu Sáng',
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-400" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h.01a1 1 0 100-2H11zM12 2.251A7.5 7.5 0 004.75 9.75c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5A7.5 7.5 0 0012 2.251zM12 15.5a5.5 5.5 0 110-11 5.5 5.5 0 010 11z" /></svg>`,
                    calculations: {
                        'tinhToanChieuSang': {
                            name: 'Tính toán số lượng đèn',
                            inputs: [
                                { label: 'Chiều dài không gian (m)', id: 'length', unit: 'm' },
                                { label: 'Chiều rộng không gian (m)', id: 'width', unit: 'm' },
                                { label: 'Cao độ treo đèn (từ đèn đến sàn) (m)', id: 'mountingHeight', unit: 'm', default: 2.8 },
                                { label: 'Chức năng (Chọn để có độ rọi gợi ý)', id: 'roomPurpose', type: 'select', options: illuminanceStandards, default: 500 },
                                { label: 'Độ rọi mong muốn (Lux)', id: 'illuminance', unit: 'Lux', default: 500 },
                                { label: 'Màu sơn tường/trần (Hệ số sử dụng)', id: 'reflectivity', type: 'select', options: reflectivityOptions, default: 0.7 },
                                { label: 'Loại đèn sử dụng', id: 'lampType', type: 'select', options: lampTypes, default: 4000 },
                                { label: 'Quang thông của đèn (Lumen)', id: 'customLumen', unit: 'lm', 'showIf': {'id': 'lampType', 'value': 'custom'} }
                            ],
                            calculate: (vals) => {
                                const area = vals.length * vals.width;
                                const E = vals.illuminance;
                                const UF_base = parseFloat(vals.reflectivity);
                                const MF = 0.8; // Maintenance Factor
                                
                                let lumenPerLamp;
                                if (vals.lampType === 'custom') {
                                    if (isNaN(vals.customLumen) || vals.customLumen <= 0) throw new Error('Vui lòng nhập Quang thông hợp lệ.');
                                    lumenPerLamp = vals.customLumen;
                                } else {
                                    lumenPerLamp = parseFloat(vals.lampType);
                                }

                                // Adjust UF based on mounting height. Simple linear adjustment.
                                // Assumes base UF is for a standard height of 2.8m.
                                const baseHeight = 2.8;
                                const heightFactor = vals.mountingHeight > 0 ? (baseHeight / vals.mountingHeight) : 1;
                                const UF_adjusted = UF_base * Math.min(1, heightFactor); // Cap factor at 1

                                const totalLumen = (E * area) / (UF_adjusted * MF);
                                const numLamps = Math.ceil(totalLumen / lumenPerLamp);

                                return {
                                    type: 'result',
                                    value: `Số lượng đèn yêu cầu: ${numLamps} cái`,
                                    unit: `(Tổng quang thông: ${Math.round(totalLumen).toLocaleString()} lm)`,
                                    note: `Gợi ý: Bố trí đèn đều trong không gian để đảm bảo độ đồng đều ánh sáng.`
                                };
                            },
                            formulaText: 'N = (E × A) / (Φ × UF × MF)'
                        }
                    }
                }
            };

            // --- DOM ELEMENTS ---
            const categoryScreen = document.getElementById('category-screen');
            const calculationScreen = document.getElementById('calculation-screen');
            const categoryButtonsContainer = document.getElementById('category-buttons');
            const backBtn = document.getElementById('back-btn');
            const calculationTitle = document.getElementById('calculation-title');
            const formulaSelect = document.getElementById('formula-select');
            const formulaTextContainer = document.getElementById('formula-text-container');
            const formulaTextEl = document.getElementById('formula-text');
            const inputFieldsContainer = document.getElementById('input-fields');
            const calculateBtn = document.getElementById('calculate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const homeBtn = document.getElementById('home-btn');
            const resultContainer = document.getElementById('result-container');
            const supportSection = document.getElementById('support-section');

            let currentCategory = null;

            // --- FUNCTIONS ---

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }

            function displayCategories() {
                categoryButtonsContainer.innerHTML = '';
                for (const key in formulas) {
                    const category = formulas[key];
                    const button = document.createElement('button');
                    button.className = 'btn card flex items-center p-4 text-left hover:bg-gray-50 hover:shadow-lg';
                    button.innerHTML = `
                        ${category.icon}
                        <span class="ml-4 font-semibold text-base">${category.name}</span>
                    `;
                    button.onclick = () => selectCategory(key);
                    categoryButtonsContainer.appendChild(button);
                }
                 // Add link to VLXD page
                const vlxdButton = document.createElement('a');
                vlxdButton.href = './indexxd.html';
                vlxdButton.className = 'btn card flex items-center p-4 text-left hover:bg-gray-50 hover:shadow-lg';
                vlxdButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 00-3 3v1.268l-1.162 3.486A1 1 0 002 15h16a1 1 0 00.95-1.317L18 8.268V7a4 4 0 00-4-4h-2zM6 9a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 01-1 1H7a1 1 0 01-1-1V9z" /></svg>
                    <span class="ml-4 font-semibold text-base">Vật liệu Xây dựng</span>
                `;
                categoryButtonsContainer.appendChild(vlxdButton);
            }

            function selectCategory(key) {
                currentCategory = key;
                const category = formulas[key];
                calculationTitle.textContent = category.name;
                
                formulaSelect.innerHTML = '';
                const calcOrder = ['chonCB1pha', 'chonCB3pha', 'chonDayDien1pha', 'chonDayDien3pha', 'tinhCongSuat1Pha', 'tinhCongSuat3Pha', 'chonMayLanh', 'chonQuatThongGio', 'chonTietDienOngGio', 'coolingload', 'chonBomTangAp', 'chonBomDayBon', 'chonBonChuaNuoc', 'chonOngCapThoat', 'flowrate', 'tinhToanChieuSang'];
                const sortedCalcs = Object.keys(category.calculations).sort((a, b) => {
                    const indexA = calcOrder.indexOf(a);
                    const indexB = calcOrder.indexOf(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                }).filter(calcKey => category.calculations[calcKey]);

                for (const calcKey of sortedCalcs) {
                    const option = document.createElement('option');
                    option.value = calcKey;
                    option.textContent = category.calculations[calcKey].name;
                    formulaSelect.appendChild(option);
                }
                
                displayFormulaInputs();
                showScreen('calculation-screen');
            }
            
            function displayFormulaInputs() {
                const calcKey = formulaSelect.value;
                if (!currentCategory || !formulas[currentCategory].calculations[calcKey]) return;

                const calculation = formulas[currentCategory].calculations[calcKey];
                
                inputFieldsContainer.innerHTML = '';
                resultContainer.innerHTML = '';
                supportSection.style.display = 'none';

                if (calculation.formulaText) {
                    formulaTextEl.textContent = calculation.formulaText;
                    formulaTextContainer.style.display = 'block';
                } else {
                    formulaTextContainer.style.display = 'none';
                }

                calculation.inputs.forEach(input => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-wrapper';
                    wrapper.id = `wrapper-${input.id}`;

                    const label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.className = "block text-sm font-medium text-gray-700 mb-1";
                    label.textContent = input.label;
                    wrapper.appendChild(label);

                    if (input.type === 'select') {
                        const selectEl = document.createElement('select');
                        selectEl.id = input.id;
                        selectEl.className = 'select-field';
                        input.options.forEach(opt => {
                            const optionEl = document.createElement('option');
                            optionEl.value = opt.value;
                            optionEl.textContent = opt.text;
                            if (String(opt.value) === String(input.default)) {
                                optionEl.selected = true;
                            }
                            selectEl.appendChild(optionEl);
                        });
                        wrapper.appendChild(selectEl);
                    } else {
                        const inputEl = document.createElement('input');
                        inputEl.type = 'number';
                        inputEl.step = 'any';
                        inputEl.id = input.id;
                        inputEl.placeholder = input.unit || '';
                        inputEl.className = 'input-field';
                        if (input.default) {
                            inputEl.value = input.default;
                        }
                        wrapper.appendChild(inputEl);
                    }
                    inputFieldsContainer.appendChild(wrapper);
                });

                // Setup conditional visibility
                setupConditionalInputs(calculation.inputs);
            }

            function setupConditionalInputs(inputs) {
                const controllers = inputs.filter(input => input.type === 'select' && inputs.some(i => i.showIf && i.showIf.id === input.id));
                
                controllers.forEach(controller => {
                    const controllerEl = document.getElementById(controller.id);
                    const updateVisibility = () => {
                        const currentValue = controllerEl.value;
                        inputs.forEach(input => {
                            if (input.showIf && input.showIf.id === controller.id) {
                                const wrapper = document.getElementById(`wrapper-${input.id}`);
                                if (input.showIf.value === currentValue) {
                                    wrapper.style.display = '';
                                } else {
                                    wrapper.style.display = 'none';
                                }
                            }
                        });
                    };
                    
                    controllerEl.addEventListener('change', updateVisibility);
                    // Initial call
                    updateVisibility();
                });

                // Special handler for illuminance standard
                const roomPurposeEl = document.getElementById('roomPurpose');
                const illuminanceEl = document.getElementById('illuminance');
                if(roomPurposeEl && illuminanceEl) {
                    roomPurposeEl.addEventListener('change', () => {
                        illuminanceEl.value = roomPurposeEl.value;
                    });
                }
            }


            function performCalculation() {
                const calcKey = formulaSelect.value;
                const calculation = formulas[currentCategory].calculations[calcKey];
                const values = {};
                let hasError = false;

                resultContainer.innerHTML = '';
                supportSection.style.display = 'none';

                calculation.inputs.forEach(input => {
                    const wrapper = document.getElementById(`wrapper-${input.id}`);
                    if (wrapper && wrapper.style.display === 'none') {
                        return;
                    }

                    const inputEl = document.getElementById(input.id);
                    const rawValue = inputEl.value;

                    if (rawValue === '' && !input.optional) {
                        showError(`Vui lòng nhập giá trị hợp lệ cho "${input.label}".`);
                        inputEl.classList.add('border-red-500');
                        hasError = true;
                        return;
                    }
                    
                    inputEl.classList.remove('border-red-500');
                    
                    if (input.type === 'select') {
                         values[input.id] = rawValue;
                    } else {
                        const numericValue = parseFloat(rawValue);
                        if (isNaN(numericValue) && rawValue !== '' && !input.optional) {
                             showError(`Giá trị không hợp lệ cho "${input.label}".`);
                             inputEl.classList.add('border-red-500');
                             hasError = true;
                        } else {
                            values[input.id] = numericValue;
                        }
                    }
                });

                if (hasError) return;

                try {
                    const result = calculation.calculate(values);
                    showResult(result);
                } catch (error) {
                    showError(error.message);
                }
            }

            function showResult(result) {
                let cardId = 'result-card';
                let cardClasses = 'card p-5 space-y-2';
                if (result.type === 'warning') {
                    cardId = 'warning-card';
                    cardClasses = 'card p-5 space-y-2 bg-orange-50 text-orange-800';
                }

                resultContainer.innerHTML = `
                    <div id="${cardId}" class="${cardClasses}">
                        <div class="text-2xl md:text-3xl font-bold">
                            ${result.value}
                        </div>
                        <p class="text-lg md:text-xl font-medium">${result.unit}</p>
                        ${result.note ? `<div class="text-sm pt-2 border-t border-gray-200 mt-2">${result.note}</div>` : ''}
                    </div>
                `;
                supportSection.style.display = 'block';
            }
            
            function showError(message) {
                 resultContainer.innerHTML = `
                    <div id="error-card" class="card p-4 bg-red-50 text-red-700">
                        <p class="font-semibold">Lỗi!</p>
                        <p>${message}</p>
                    </div>
                `;
                supportSection.style.display = 'none';
            }

            function clearFields() {
                inputFieldsContainer.querySelectorAll('input, select').forEach(field => {
                    const fieldId = field.id;
                    const calcKey = formulaSelect.value;
                    const calc = formulas[currentCategory].calculations[calcKey];
                    const inputDef = calc.inputs.find(i => i.id === fieldId);
                    if (inputDef && inputDef.default) {
                        field.value = inputDef.default;
                    } else {
                        field.value = '';
                    }
                    field.classList.remove('border-red-500');
                });
                resultContainer.innerHTML = '';
                supportSection.style.display = 'none';
                const calc = formulas[currentCategory].calculations[formulaSelect.value];
                setupConditionalInputs(calc.inputs);
            }

            // --- EVENT LISTENERS ---
            function goToHome() {
                showScreen('category-screen');
                resultContainer.innerHTML = '';
                supportSection.style.display = 'none';
            }

            backBtn.addEventListener('click', goToHome);
            homeBtn.addEventListener('click', goToHome);
            
            formulaSelect.addEventListener('change', displayFormulaInputs);
            calculateBtn.addEventListener('click', performCalculation);
            clearBtn.addEventListener('click', clearFields);

            // --- INITIALIZATION ---
            displayCategories();
        });
    </script>
</body>
</html>
